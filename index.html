<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hunt3rs of Latimer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #1a202c; /* gray-900 */
            color: #ffffff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Custom modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #2d3748; /* gray-800 */
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            max-width: 28rem; /* max-w-md */
            width: 100%;
            position: relative;
            border: 1px solid #4a5568; /* border-gray-700 */
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #a0aec0; /* gray-400 */
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        /* Specific styling for message/post lists */
        .message-list, .post-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #2d3748;
        }
        .message-item, .post-item {
            background-color: #1a202c;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word; /* Ensure long words break */
        }
        .message-item:last-child, .post-item:last-child {
            margin-bottom: 0;
        }
        .message-sender, .post-author {
            font-weight: bold;
            color: #63b3ed; /* blue-300 */
        }
        .message-timestamp, .post-timestamp {
            font-size: 0.75rem;
            color: #a0aec0; /* gray-400 */
            margin-left: 0.5rem;
        }
        /* Styling for the text editor toolbar */
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        .editor-toolbar button {
            padding: 0.5rem 0.75rem;
            background-color: #4a5568;
            border-radius: 0.375rem;
            font-weight: 600;
            color: #cbd5e0;
            transition: background-color 0.2s;
        }
        .editor-toolbar button:hover {
            background-color: #636b7a;
        }
        .editor-toolbar button.active {
            background-color: #38a169; /* green-600 */
            color: #ffffff;
        }
        .color-picker-wrapper {
            position: relative;
        }
        .color-picker {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.375rem;
            padding: 0.5rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            z-index: 10;
        }
        .color-box {
            width: 24px;
            height: 24px;
            border-radius: 0.25rem;
            cursor: pointer;
            border: 1px solid #636b7a;
        }
        .emoji-picker {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.375rem;
            padding: 0.5rem;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.25rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }
        .emoji-item {
            font-size: 1.5rem;
            cursor: pointer;
            text-align: center;
            padding: 0.2rem;
            border-radius: 0.25rem;
            transition: background-color 0.1s;
        }
        .emoji-item:hover {
            background-color: #4a5568;
        }
        /* GIF Search Modal Specific Styles */
        .gif-search-modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 600px; /* Wider for GIF results */
            width: 100%;
            position: relative;
            border: 1px solid #4a5568;
            max-height: 80vh; /* Limit height */
            display: flex;
            flex-direction: column;
        }
        .gif-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Responsive grid */
            gap: 0.75rem;
            max-height: calc(80vh - 180px); /* Adjust based on header/footer height */
            overflow-y: auto;
            padding: 0.5rem;
            margin-top: 1rem;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            background-color: #1a202c;
        }
        .gif-results-grid img {
            width: 100%;
            height: 100px; /* Fixed height for consistency */
            object-fit: cover; /* Cover the area */
            border-radius: 0.375rem;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .gif-results-grid img:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-white font-inter flex flex-col">

    <!-- Header and Navigation -->
    <header class="bg-gray-800 shadow-lg py-4 px-6 md:px-12 flex flex-col md:flex-row justify-between items-center rounded-b-lg">
        <h1 class="text-4xl font-extrabold text-teal-400 mb-4 md:mb-0">The Hunt3rs of Latimer</h1>
        <nav class="flex flex-wrap justify-center gap-4">
            <button id="homeBtn" class="px-6 py-3 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75">
                Home
            </button>
            <button id="memberMenuBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                Member Menu
            </button>
            <button id="servicesBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Services
            </button>
            <button id="dmBtn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                Direct Messages
            </button>
            <button id="groupChatBtn" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75">
                Message Groups
            </button>
            <button id="forumBtn" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                Forum
            </button>
            <button id="adminMenuBtn" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75 hidden">
                Admin Menu
            </button>
            <button id="masterMenuBtn" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 hidden">
                Master Menu
            </button>
            <button id="authBtn" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                Login
            </button>
        </nav>
    </header>

    <!-- Main content area where pages are rendered -->
    <main id="app-content" class="flex-grow p-6 md:p-12 flex items-center justify-center">
        <div class="bg-gray-800 p-8 md:p-12 rounded-xl shadow-2xl max-w-4xl w-full text-center border border-gray-700">
            <!-- Content will be injected here by JavaScript -->
            <div class="text-center text-xl text-gray-400">Loading website data...</div>
        </div>
    </main>

    <!-- Login Modal Container -->
    <div id="loginModalContainer"></div>

    <!-- Confirmation Modal Container -->
    <div id="confirmModalContainer"></div>

    <!-- Emoji Picker Modal Container -->
    <div id="emojiPickerContainer"></div>

    <!-- GIF Search Modal Container -->
    <div id="gifSearchModalContainer"></div>

    <!-- Footer -->
    <footer class="bg-gray-800 shadow-lg py-4 px-6 md:px-12 text-center text-gray-400 rounded-t-lg mt-auto">
        <p>&copy; <span id="currentYear"></span> The Hunt3rs of Latimer. All rights reserved.</p>
        <p id="userIdDisplay" class="text-xs mt-1 hidden"></p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Realtime Database imports
        import { getDatabase, ref, onValue, set, remove, push } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Global variables for Firebase and app state
        let db; // This will now be the Realtime Database instance
        let auth;
        let currentUserId = null;
        let isAuthReady = false; // To ensure auth is ready before DB ops
        let appId; // Declare appId globally

        // Application specific states
        let loggedInUser = null; // { username: '...', role: 'member' | 'admin' | 'master' }
        let accounts = []; // Accounts fetched from Realtime Database
        let currentPage = 'home';
        let confirmModalCallback = null; // Callback for custom confirmation modal

        // State for messaging/forum features
        let currentDMRecipient = null; // Username of the person being DMed
        let currentGroup = null; // Object for the currently viewed group
        let currentForumTopic = null; // Object for the currently viewed forum topic

        // Styling state for current message input
        let currentMessageStyle = {
            bold: false,
            italic: false,
            color: '#ffffff', // Default white
            gifUrl: null // For GIF support
        };
        let activeMessageInput = null; // Reference to the currently active textarea

        // Hardcoded access codes (for simulation only - in a real app, these would be managed securely)
        const ADMIN_CODE = "fe4rtf-ds3Fl2-d2x5fg-f43eFd";
        const MASTER_CODE = "master!avash+$[]1234";

        // --- Utility Functions ---

        // Function to show a custom confirmation modal
        function showConfirmModal(message, callback) {
            const container = document.getElementById('confirmModalContainer');
            container.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content text-center">
                        <h3 class="text-2xl font-bold text-yellow-300 mb-4">Confirm Action</h3>
                        <p class="text-lg text-gray-300 mb-6">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmYesBtn" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                                Yes
                            </button>
                            <button id="confirmNoBtn" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                                No
                            </button>
                        </div>
                    </div>
                </div>
            `;
            confirmModalCallback = callback;

            document.getElementById('confirmYesBtn').onclick = () => {
                confirmModalCallback(true);
                container.innerHTML = ''; // Close modal
                confirmModalCallback = null;
            };
            document.getElementById('confirmNoBtn').onclick = () => {
                confirmModalCallback(false);
                container.innerHTML = ''; // Close modal
                confirmModalCallback = null;
            };
        }

        // Helper to format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString(); // Adjust as needed for specific format
        }

        // Function to insert text/emoji at cursor position
        function insertAtCursor(input, textToInsert) {
            if (!input) return;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = input.value.substring(0, start) + textToInsert + input.value.substring(end, input.value.length);
            input.selectionStart = input.selectionEnd = start + textToInsert.length;
            input.focus();
        }

        // --- Styling Toolbar Functions ---
        function setupStylingToolbar(textareaId, toolbarId) {
            const textarea = document.getElementById(textareaId);
            const toolbar = document.getElementById(toolbarId);
            if (!textarea || !toolbar) return;

            const boldBtn = toolbar.querySelector('.bold-btn');
            const italicBtn = toolbar.querySelector('.italic-btn');
            const colorBtn = toolbar.querySelector('.color-btn');
            const gifBtn = toolbar.querySelector('.gif-btn');
            const emojiBtn = toolbar.querySelector('.emoji-btn');

            // Initialize active state based on currentMessageStyle
            const updateButtonStates = () => {
                if (currentMessageStyle.bold) boldBtn.classList.add('active'); else boldBtn.classList.remove('active');
                if (currentMessageStyle.italic) italicBtn.classList.add('active'); else italicBtn.classList.remove('active');
                // Color button doesn't have an active state, but its color might change
                colorBtn.style.color = currentMessageStyle.color;
            };

            boldBtn.onclick = () => {
                currentMessageStyle.bold = !currentMessageStyle.bold;
                updateButtonStates();
            };
            italicBtn.onclick = () => {
                currentMessageStyle.italic = !currentMessageStyle.italic;
                updateButtonStates();
            };
            colorBtn.onclick = (event) => {
                showColorPicker(event.target, (color) => {
                    currentMessageStyle.color = color;
                    updateButtonStates();
                });
            };
            gifBtn.onclick = () => {
                activeMessageInput = textarea; // Set the active textarea before opening the GIF modal
                showGifSearchModal();
            };
            emojiBtn.onclick = (event) => {
                showEmojiPicker(event.target, textarea);
            };

            // Set active input for styling
            textarea.onfocus = () => {
                activeMessageInput = textarea;
                // Reset style for new input, or apply saved style if editing
                currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null }; // Reset gifUrl here
                updateButtonStates();
            };

            // Initial state update
            updateButtonStates();
        }

        function showColorPicker(buttonElement, callback) {
            const container = document.getElementById('confirmModalContainer'); // Reusing modal container
            container.innerHTML = `
                <div class="modal-overlay" id="colorPickerOverlay">
                    <div class="color-picker" style="position: absolute; top: ${buttonElement.offsetTop + buttonElement.offsetHeight + 10}px; left: ${buttonElement.offsetLeft}px;">
                        <div class="color-box" style="background-color: #FF0000;" data-color="#FF0000"></div>
                        <div class="color-box" style="background-color: #00FF00;" data-color="#00FF00"></div>
                        <div class="color-box" style="background-color: #0000FF;" data-color="#0000FF"></div>
                        <div class="color-box" style="background-color: #FFFF00;" data-color="#FFFF00"></div>
                        <div class="color-box" style="background-color: #FF00FF;" data-color="#FF00FF"></div>
                        <div class="color-box" style="background-color: #00FFFF;" data-color="#00FFFF"></div>
                        <div class="color-box" style="background-color: #FFFFFF;" data-color="#FFFFFF"></div>
                        <div class="color-box" style="background-color: #000000;" data-color="#000000"></div>
                    </div>
                </div>
            `;
            const colorPicker = container.querySelector('.color-picker');

            colorPicker.querySelectorAll('.color-box').forEach(box => {
                box.onclick = () => {
                    callback(box.dataset.color);
                    container.innerHTML = ''; // Close picker
                };
            });

            // Close picker if click outside
            document.getElementById('colorPickerOverlay').onclick = (event) => {
                if (event.target.id === 'colorPickerOverlay') {
                    container.innerHTML = '';
                }
            };
        }

        const emojis = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜',
            'ğŸ˜', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ˜®', 'ğŸ¤', 'ğŸ˜', 'ğŸ˜‘',
            'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ï¿½', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·',
            'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜‡', 'ğŸ¤ ', 'ğŸ¤¡', 'ğŸ¥³', 'ğŸ¥º', 'ğŸ¤©', 'ğŸ¤¯',
            'ğŸ¤ª', 'ğŸ˜µ', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ¤–', 'ğŸ’©',
            'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ™', 'ğŸ’ª', 'ğŸ‘€', 'âœ¨', 'ğŸ”¥', 'ğŸ‰', 'ğŸ’¯',
            'â¤ï¸', 'ğŸ’”', 'ğŸ’–', 'ğŸ’™', 'ğŸ’š', 'ğŸ’›', 'ğŸ§¡', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸŒˆ',
            'â˜€ï¸', 'ğŸŒ™', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'âš¡', 'ğŸ’¥', 'ğŸ’¦', 'ğŸ’§', 'ğŸŒŠ', 'ğŸ', 'ğŸ“',
            'ğŸ•', 'ğŸ”', 'ğŸŸ', 'ğŸ¦', 'ğŸ©', 'â˜•', 'ğŸº', 'ğŸ‰', 'ğŸ', 'ğŸˆ', 'ğŸµ', 'ğŸ¶'
        ];

        function showEmojiPicker(buttonElement, targetInput) {
            const container = document.getElementById('emojiPickerContainer');
            container.innerHTML = `
                <div class="modal-overlay" id="emojiPickerOverlay">
                    <div class="emoji-picker" style="position: absolute; top: ${buttonElement.offsetTop + buttonElement.offsetHeight + 10}px; left: ${buttonElement.offsetLeft}px;">
                        ${emojis.map(emoji => `<span class="emoji-item">${emoji}</span>`).join('')}
                    </div>
                </div>
            `;
            const emojiPicker = container.querySelector('.emoji-picker');

            emojiPicker.querySelectorAll('.emoji-item').forEach(item => {
                item.onclick = () => {
                    insertAtCursor(targetInput, item.textContent);
                    container.innerHTML = ''; // Close picker
                };
            });

            // Close picker if click outside
            document.getElementById('emojiPickerOverlay').onclick = (event) => {
                if (event.target.id === 'emojiPickerOverlay') {
                    container.innerHTML = '';
                }
            };
        }

        // --- GIF Search Modal Functions ---
        const TENOR_API_KEY = "AIzaSyCxLytkSuWIpQh2XgBCaO58CQEdKh-ryog"; // <<< IMPORTANT: Replace with your actual Tenor API Key

        async function searchTenorGifs(query) {
            if (!TENOR_API_KEY || TENOR_API_KEY === "YOUR_TENOR_API_KEY") {
                console.error("Tenor API Key is not set. Please replace 'YOUR_TENOR_API_KEY' with your actual key.");
                // Optionally, display a user-friendly message in the modal
                return [];
            }
            const url = `https://api.tenor.com/v1/search?q=${encodeURIComponent(query)}&key=${TENOR_API_KEY}&limit=20&media_filter=basic`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.results; // Array of GIF objects
            } catch (error) {
                console.error("Error searching Tenor GIFs:", error);
                // Instead of alert, log to console or show a temporary message in the modal
                // alert("Failed to search GIFs. Please check your Tenor API key and network connection. (CORS might be an issue if running locally without a proxy)");
                return [];
            }
        }

        function showGifSearchModal() {
            const container = document.getElementById('gifSearchModalContainer');
            container.innerHTML = `
                <div class="modal-overlay">
                    <div class="gif-search-modal-content">
                        <button class="modal-close-button">&times;</button>
                        <h2 class="text-3xl font-bold text-blue-300 mb-4 text-center">Search GIFs</h2>
                        <input
                            type="text"
                            id="gifSearchInput"
                            class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
                            placeholder="Search for GIFs..."
                        />
                        <div id="gifSearchResults" class="gif-results-grid">
                            <p class="text-gray-400 text-center col-span-full">Type to search for GIFs...</p>
                        </div>
                    </div>
                </div>
            `;

            document.querySelector('#gifSearchModalContainer .modal-close-button').onclick = () => container.innerHTML = '';
            const gifSearchInput = document.getElementById('gifSearchInput');
            const gifSearchResultsDiv = document.getElementById('gifSearchResults');

            gifSearchInput.addEventListener('input', async () => {
                const query = gifSearchInput.value.trim();
                if (query.length > 2) { // Only search for longer queries
                    gifSearchResultsDiv.innerHTML = '<p class="text-gray-400 text-center col-span-full">Loading GIFs...</p>';
                    const gifs = await searchTenorGifs(query);
                    displayGifs(gifs, gifSearchResultsDiv);
                } else {
                    gifSearchResultsDiv.innerHTML = '<p class="text-gray-400 text-center col-span-full">Type to search for GIFs...</p>';
                }
            });

            gifSearchInput.focus();
        }

        function displayGifs(gifs, resultsContainer) {
            resultsContainer.innerHTML = '';
            if (gifs.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">No GIFs found for this search.</p>';
                return;
            }
            gifs.forEach(gif => {
                const img = document.createElement('img');
                // Use the 'tinygif' or 'nanogif' for previews, and 'gif' for full quality
                img.src = gif.media[0].tinygif.url; // Preview URL
                img.dataset.fullGifUrl = gif.media[0].gif.url; // Store full URL
                img.alt = gif.content_description;
                img.className = 'w-full h-auto rounded-md cursor-pointer hover:opacity-80 transition-opacity';
                img.onerror = function() {
                    this.src = `https://placehold.co/100x100/FF0000/FFFFFF?text=GIF+Error`;
                };
                img.onclick = () => {
                    if (activeMessageInput) {
                        currentMessageStyle.gifUrl = img.dataset.fullGifUrl; // Set the full GIF URL
                        activeMessageInput.value = ''; // Clear text input
                        document.getElementById('gifSearchModalContainer').innerHTML = ''; // Close modal
                        console.log("GIF selected! It will be sent with your message. You can still add text as a caption.");
                        // The setupStylingToolbar will be called on next focus, resetting the style.
                        // We need to ensure gifUrl persists until send.
                        // This is handled by currentMessageStyle being global.
                    } else {
                        console.warn("No active message input found when selecting GIF.");
                        document.getElementById('gifSearchModalContainer').innerHTML = ''; // Close modal
                    }
                };
                resultsContainer.appendChild(img);
            });
        }


        // --- Page Rendering Functions ---

        function renderHomePage() {
            const contentDiv = document.getElementById('app-content').querySelector('div');
            contentDiv.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-5xl font-bold text-teal-300 mb-4">Welcome to The Hunt3rs of Latimer</h2>
                    <p class="text-lg text-gray-300 leading-relaxed">
                        Dedicated to excellence and precision in every endeavor. We are a collective of skilled individuals,
                        committed to achieving your objectives with unparalleled expertise and discretion.
                    </p>
                    <p class="text-lg text-gray-300 leading-relaxed">
                        Explore our services and discover how we can assist you.
                    </p>
                    <div class="mt-8 flex justify-center space-x-4">
                        <button class="px-8 py-4 bg-gradient-to-r from-teal-500 to-teal-700 text-white font-bold text-xl rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                            Learn More
                        </button>
                        <button class="px-8 py-4 bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold text-xl rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                            Contact Us
                        </button>
                    </div>
                </div>
            `;
        }

        function renderMemberMenuPage() {
            const contentDiv = document.getElementById('app-content').querySelector('div');
            const usernameDisplay = loggedInUser ? `<p class="text-xl text-gray-200">Welcome, <span class="font-semibold text-purple-400">${loggedInUser.username}</span>!</p>` : '';
            contentDiv.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-4xl font-bold text-purple-300 mb-4">Member Menu</h2>
                    ${usernameDisplay}
                    <p class="text-lg text-gray-300 leading-relaxed">
                        This section is exclusively for our esteemed members. Here you can access your personalized dashboard,
                        mission briefings, secure communications, and exclusive resources.
                    </p>
                    <ul class="list-disc list-inside text-left text-gray-300 mx-auto max-w-md space-y-2">
                        <li>Access Mission Control</li>
                        <li>View Personal Dossier</li>
                        <li>Secure Message Center</li>
                        <li>Training & Development</li>
                        <li>Resource Library</li>
                    </ul>
                    <p class="mt-6 text-sm text-gray-400">
                        Note: Accounts are now persistent and saved in Firebase Realtime Database.
                    </p>
                </div>
            `;
        }

        function renderServicesPage() {
            const contentDiv = document.getElementById('app-content').querySelector('div');
            contentDiv.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-4xl font-bold text-blue-300 mb-4">Our Services: Group Offerings</h2>
                    <p class="text-lg text-gray-300 leading-relaxed">
                        The Hunt3rs of Latimer specializes in providing tailored group service offerings. We focus on delivering comprehensive solutions and coordinated efforts for organizations and teams seeking to achieve their collective objectives. Our expertise ensures seamless collaboration and impactful results for larger-scale endeavors.
                    </p>
                    <button class="mt-8 px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-800 text-white font-bold text-xl rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                        Group Services
                    </button>
                </div>
            `;
        }

        function renderAdminMenuPage() {
            const contentDiv = document.getElementById('app-content').querySelector('div');
            const usernameDisplay = loggedInUser ? `<p class="text-lg text-gray-300 leading-relaxed">Welcome, <span class="font-semibold text-orange-400">${loggedInUser.username}</span>! Here you can manage user accounts.</p>` : '';

            contentDiv.innerHTML = `
                <div class="space-y-6 text-center">
                    <h2 class="text-4xl font-bold text-orange-300 mb-4">Admin Menu</h2>
                    ${usernameDisplay}

                    <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600 mx-auto max-w-md">
                        <h3 class="text-2xl font-semibold text-orange-200 mb-4">Create New Account</h3>
                        <form id="createAccountForm" class="space-y-4">
                            <div>
                                <label for="newUsername" class="block text-gray-300 text-left mb-2">Username:</label>
                                <input
                                    type="text"
                                    id="newUsername"
                                    class="w-full p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-orange-500"
                                    required
                                />
                            </div>
                            <div>
                                <label for="newPassword" class="block text-gray-300 text-left mb-2">Password:</label>
                                <input
                                    type="password"
                                    id="newPassword"
                                    class="w-full p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-orange-500"
                                    required
                                />
                            </div>
                            <div>
                                <label for="newRole" class="block text-gray-300 text-left mb-2">Role:</label>
                                <select
                                    id="newRole"
                                    class="w-full p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-orange-500"
                                >
                                    <option value="member">Member</option>
                                    ${loggedInUser && loggedInUser.role === 'master' ? '<option value="admin">Admin</option>' : ''}
                                </select>
                            </div>
                            <p id="adminMessage" class="text-sm"></p>
                            <button
                                type="submit"
                                id="createAccountBtn"
                                class="w-full py-3 bg-gradient-to-r from-orange-500 to-amber-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75"
                            >
                                Create Account
                            </button>
                        </form>
                    </div>

                    <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600 mx-auto max-w-lg mt-8">
                        <h3 class="text-2xl font-semibold text-orange-200 mb-4">Existing Accounts (Persistent)</h3>
                        <ul id="accountsList" class="list-disc list-inside text-left text-gray-300 space-y-2">
                            ${accounts.length === 0 ? '<p class="text-gray-400">No accounts found. Create one above!</p>' :
                                accounts.map(acc => `
                                    <li class="flex justify-between items-center">
                                        <span><span class="font-semibold">${acc.username}</span> (Role: ${acc.role})</span>
                                        ${(loggedInUser && (loggedInUser.role === 'master' || (loggedInUser.role === 'admin' && acc.role === 'member'))) ? `
                                            <button data-id="${acc.id}" data-username="${acc.username}" class="delete-account-btn ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded-full transition duration-300">
                                                Delete
                                            </button>
                                        ` : ''}
                                    </li>
                                `).join('')
                            }
                        </ul>
                        <p class="mt-4 text-sm text-gray-400">
                            Note: These accounts are stored in Firebase Realtime Database and persist across sessions.
                        </p>
                    </div>
                </div>
            `;

            // Add event listeners after rendering
            document.getElementById('createAccountForm').addEventListener('submit', handleCreateAccount);
            document.querySelectorAll('.delete-account-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const accountId = event.target.dataset.id;
                    const username = event.target.dataset.username;
                    handleDeleteAccount(accountId, username);
                });
            });
        }

        function renderMasterMenuPage() {
            const contentDiv = document.getElementById('app-content').querySelector('div');
            const usernameDisplay = loggedInUser ? `<p class="text-lg text-gray-300 leading-relaxed">Welcome, <span class="font-semibold text-red-400">${loggedInUser.username}</span>! You have master control. Here you can create new admin accounts and manage all accounts.</p>` : '';

            contentDiv.innerHTML = `
                <div class="space-y-6 text-center">
                    <h2 class="text-4xl font-bold text-red-300 mb-4">Master Menu</h2>
                    ${usernameDisplay}

                    <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600 mx-auto max-w-md">
                        <h3 class="text-2xl font-semibold text-red-200 mb-4">Create New Account</h3>
                        <form id="createMasterAccountForm" class="space-y-4">
                            <div>
                                <label for="newMasterUsername" class="block text-gray-300 text-left mb-2">Username:</label>
                                <input
                                    type="text"
                                    id="newMasterUsername"
                                    class="w-full p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-red-500"
                                    required
                                />
                            </div>
                            <div>
                                <label for="newMasterPassword" class="block text-gray-300 text-left mb-2">Password:</label>
                                <input
                                    type="password"
                                    id="newMasterPassword"
                                    class="w-full p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-red-500"
                                    required
                                />
                            </div>
                            <div>
                                <label for="newMasterRole" class="block text-gray-300 text-left mb-2">Role:</label>
                                <select
                                    id="newMasterRole"
                                    class="w-full p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-red-500"
                                >
                                    <option value="member">Member</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <p id="masterMessage" class="text-sm"></p>
                            <button
                                type="submit"
                                id="createMasterAccountBtn"
                                class="w-full py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75"
                            >
                                Create Account
                            </button>
                        </form>
                    </div>

                    <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600 mx-auto max-w-lg mt-8">
                        <h3 class="text-2xl font-semibold text-red-200 mb-4">Existing Accounts (Persistent)</h3>
                        <ul id="masterAccountsList" class="list-disc list-inside text-left text-gray-300 space-y-2">
                            ${accounts.length === 0 ? '<p class="text-gray-400">No accounts found. Create one above!</p>' :
                                accounts.map(acc => `
                                    <li class="flex justify-between items-center">
                                        <span><span class="font-semibold">${acc.username}</span> (Role: ${acc.role})</span>
                                        <button data-id="${acc.id}" data-username="${acc.username}" class="delete-account-btn ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded-full transition duration-300">
                                            Delete
                                        </button>
                                    </li>
                                `).join('')
                            }
                        </ul>
                        <p class="mt-4 text-sm text-gray-400">
                            Note: These accounts are stored in Firebase Realtime Database and persist across sessions.
                        </p>
                    </div>
                </div>
            `;

            // Add event listeners after rendering
            document.getElementById('createMasterAccountForm').addEventListener('submit', handleCreateMasterAccount);
            document.querySelectorAll('.delete-account-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const accountId = event.target.dataset.id;
                    const username = event.target.dataset.username;
                    handleDeleteAccount(accountId, username);
                });
            });
        }

        // --- Direct Messages Page ---
        function renderDirectMessagesPage() {
            if (!loggedInUser) {
                renderAuthRequiredMessage("Please log in to use Direct Messages.");
                return;
            }

            const contentDiv = document.getElementById('app-content').querySelector('div');
            contentDiv.innerHTML = `
                <div class="space-y-6 text-center w-full max-w-3xl mx-auto">
                    <h2 class="text-4xl font-bold text-green-300 mb-4">Direct Messages</h2>
                    <p class="text-lg text-gray-300 leading-relaxed">
                        Send private messages to other members.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
                            <h3 class="text-2xl font-semibold text-green-200 mb-4">Conversations</h3>
                            <ul id="dmUsersList" class="text-left space-y-2">
                                <!-- Other members will be listed here -->
                            </ul>
                        </div>
                        <div class="md:col-span-2 bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
                            <h3 id="dmChatHeader" class="text-2xl font-semibold text-green-200 mb-4">Select a User to Chat</h3>
                            <div id="dmChatWindow" class="message-list h-80 mb-4 flex flex-col-reverse">
                                <!-- Messages will appear here -->
                            </div>
                            <div id="dmToolbar" class="editor-toolbar">
                                <button class="bold-btn"><strong>B</strong></button>
                                <button class="italic-btn"><em>I</em></button>
                                <button class="color-btn">Color</button>
                                <button class="emoji-btn">ğŸ˜€</button>
                                <button class="gif-btn">GIF</button>
                            </div>
                            <form id="dmMessageForm" class="flex gap-2">
                                <textarea
                                    id="dmMessageInput"
                                    class="flex-grow p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-green-500"
                                    placeholder="Type your message..."
                                    rows="3"
                                    disabled
                                ></textarea>
                                <button
                                    type="submit"
                                    id="dmSendBtn"
                                    class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75"
                                    disabled
                                >
                                    Send
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Populate DM users list
            const dmUsersList = document.getElementById('dmUsersList');
            const otherAccounts = accounts.filter(acc => acc.username !== loggedInUser.username);
            if (otherAccounts.length === 0) {
                dmUsersList.innerHTML = '<li class="text-gray-400">No other members found.</li>';
            } else {
                dmUsersList.innerHTML = otherAccounts.map(acc => `
                    <li>
                        <button class="dm-user-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md w-full text-left transition duration-200" data-username="${acc.username}">
                            ${acc.username}
                        </button>
                    </li>
                `).join('');
            }

            // Setup styling toolbar for DM input
            setupStylingToolbar('dmMessageInput', 'dmToolbar');

            // Add event listeners for DM user buttons
            document.querySelectorAll('.dm-user-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const recipientUsername = event.target.dataset.username;
                    startDMConversation(recipientUsername);
                });
            });

            document.getElementById('dmMessageForm').addEventListener('submit', handleSendDM);
        }

        function startDMConversation(recipientUsername) {
            currentDMRecipient = recipientUsername;
            document.getElementById('dmChatHeader').textContent = `Chat with ${recipientUsername}`;
            document.getElementById('dmMessageInput').disabled = false;
            document.getElementById('dmSendBtn').disabled = false;
            document.getElementById('dmMessageInput').focus();

            // Enable toolbar buttons
            document.getElementById('dmToolbar').querySelectorAll('button').forEach(btn => btn.disabled = false);

            // Reset message style for new conversation
            currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null };
            setupStylingToolbar('dmMessageInput', 'dmToolbar'); // Re-init to update button states

            // Clean up previous listener if any
            if (window.dmListenerOff) {
                window.dmListenerOff();
                window.dmListenerOff = null;
            }

            // Determine the conversation path (sorted usernames for consistency)
            const users = [loggedInUser.username, recipientUsername].sort();
            const conversationPath = `artifacts/${appId}/public/data/dms/${users[0]}_${users[1]}/messages`;
            const dmMessagesRef = ref(db, conversationPath);

            // Set up new listener
            window.dmListenerOff = onValue(dmMessagesRef, (snapshot) => {
                const messagesData = snapshot.val();
                const dmChatWindow = document.getElementById('dmChatWindow');
                dmChatWindow.innerHTML = ''; // Clear previous messages

                if (messagesData) {
                    // Convert object to array, sort by timestamp
                    const messages = Object.keys(messagesData).map(key => ({
                        id: key,
                        ...messagesData[key]
                    })).sort((a, b) => a.timestamp - b.timestamp);

                    messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message-item text-left';

                        let contentHtml = '';
                        if (msg.content.gifUrl) {
                            contentHtml = `<img src="${msg.content.gifUrl}" alt="GIF" class="max-w-full h-auto rounded-md mt-1" onerror="this.onerror=null;this.src='https://placehold.co/200x150/FF0000/FFFFFF?text=GIF+Error';">`;
                            if (msg.content.text) { // Add text as caption if present
                                contentHtml += `<p class="text-gray-200 mt-1" style="font-weight:${msg.content.style?.bold ? 'bold' : 'normal'}; font-style:${msg.content.style?.italic ? 'italic' : 'normal'}; color:${msg.content.style?.color || '#ffffff'};">${msg.content.text}</p>`;
                            }
                        } else if (msg.content.text) {
                            contentHtml = `<p class="text-gray-200 mt-1" style="font-weight:${msg.content.style?.bold ? 'bold' : 'normal'}; font-style:${msg.content.style?.italic ? 'italic' : 'normal'}; color:${msg.content.style?.color || '#ffffff'};">${msg.content.text}</p>`;
                        }

                        messageElement.innerHTML = `
                            <span class="message-sender">${msg.sender}</span>
                            <span class="message-timestamp">${formatTimestamp(msg.timestamp)}</span>
                            ${contentHtml}
                        `;
                        dmChatWindow.prepend(messageElement); // Add to top to keep scroll at bottom
                    });
                    dmChatWindow.scrollTop = dmChatWindow.scrollHeight; // Scroll to bottom
                } else {
                    dmChatWindow.innerHTML = '<p class="text-gray-400 text-center">No messages yet. Start the conversation!</p>';
                }
            }, (error) => {
                console.error("Error fetching DMs:", error);
                document.getElementById('dmChatWindow').innerHTML = `<p class="text-red-400 text-center">Error loading messages: ${error.message}</p>`;
            });
        }

        async function handleSendDM(event) {
            event.preventDefault();
            if (!loggedInUser || !currentDMRecipient) return;

            const dmMessageInput = document.getElementById('dmMessageInput');
            const messageText = dmMessageInput.value.trim();

            const messageContent = {};

            // If there's text, add it with its style
            if (messageText) {
                messageContent.text = messageText;
                messageContent.style = {
                    bold: currentMessageStyle.bold,
                    italic: currentMessageStyle.italic,
                    color: currentMessageStyle.color
                };
            }

            // Add GIF if a GIF URL is set
            if (currentMessageStyle.gifUrl) {
                messageContent.gifUrl = currentMessageStyle.gifUrl;
            }

            // If neither text nor GIF is present, warn and stop
            if (!messageContent.text && !messageContent.gifUrl) {
                console.warn("Attempted to send empty message: No text and no GIF provided.");
                return;
            }

            const users = [loggedInUser.username, currentDMRecipient].sort();
            const conversationPath = `artifacts/${appId}/public/data/dms/${users[0]}_${users[1]}/messages`;
            const dmMessagesRef = ref(db, conversationPath);

            try {
                await push(dmMessagesRef, {
                    sender: loggedInUser.username,
                    content: messageContent,
                    timestamp: Date.now()
                });
                dmMessageInput.value = ''; // Clear input
                // Reset styling and GIF URL after sending
                currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null };
                setupStylingToolbar('dmMessageInput', 'dmToolbar'); // Re-init to update button states
            } catch (error) {
                console.error("Error sending DM:", error);
                // alert("Failed to send message: " + error.message); // Replaced with console.error
            }
        }

        // --- Message Groups Page ---
        function renderMessageGroupsPage() {
            if (!loggedInUser) {
                renderAuthRequiredMessage("Please log in to use Message Groups.");
                return;
            }

            const contentDiv = document.getElementById('app-content').querySelector('div');
            contentDiv.innerHTML = `
                <div class="space-y-6 text-center w-full max-w-4xl mx-auto">
                    <h2 class="text-4xl font-bold text-yellow-300 mb-4">Message Groups</h2>
                    <p class="text-lg text-gray-300 leading-relaxed">
                        Create and join private message groups.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
                            <h3 class="text-2xl font-semibold text-yellow-200 mb-4">Your Groups</h3>
                            <button id="createGroupBtn" class="w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-md mb-4 transition duration-300">
                                Create New Group
                            </button>
                            <ul id="groupsList" class="text-left space-y-2">
                                <!-- Groups will be listed here -->
                            </ul>
                        </div>
                        <div class="md:col-span-2 bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
                            <h3 id="groupChatHeader" class="text-2xl font-semibold text-yellow-200 mb-4">Select a Group to Chat</h3>
                            <div id="groupChatWindow" class="message-list h-80 mb-4 flex flex-col-reverse">
                                <!-- Group messages will appear here -->
                            </div>
                            <div id="groupToolbar" class="editor-toolbar">
                                <button class="bold-btn"><strong>B</strong></button>
                                <button class="italic-btn"><em>I</em></button>
                                <button class="color-btn">Color</button>
                                <button class="emoji-btn">ğŸ˜€</button>
                                <button class="gif-btn">GIF</button>
                            </div>
                            <form id="groupMessageForm" class="flex gap-2">
                                <textarea
                                    id="groupMessageInput"
                                    class="flex-grow p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    placeholder="Type your message..."
                                    rows="3"
                                    disabled
                                ></textarea>
                                <button
                                    type="submit"
                                    id="groupSendBtn"
                                    class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75"
                                    disabled
                                >
                                    Send
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('createGroupBtn').onclick = showCreateGroupModal;
            document.getElementById('groupMessageForm').addEventListener('submit', handleSendGroupMessage);

            // Setup styling toolbar for group input
            setupStylingToolbar('groupMessageInput', 'groupToolbar');

            // Fetch and display groups
            fetchAndDisplayGroups();
        }

        function showCreateGroupModal() {
            const container = document.getElementById('confirmModalContainer'); // Reusing confirm modal container
            container.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-button">&times;</button>
                        <h2 class="text-3xl font-bold text-yellow-300 mb-6 text-center">Create New Group</h2>
                        <form id="createGroupForm" class="space-y-4">
                            <div>
                                <label for="groupNameInput" class="block text-gray-300 text-left mb-2">Group Name:</label>
                                <input
                                    type="text"
                                    id="groupNameInput"
                                    class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    required
                                />
                            </div>
                            <div>
                                <label class="block text-gray-300 text-left mb-2">Add Members (select from list):</label>
                                <div id="memberSelectionList" class="bg-gray-600 p-3 rounded-md max-h-40 overflow-y-auto">
                                    <!-- Members will be dynamically loaded here -->
                                </div>
                            </div>
                            <p id="createGroupMessage" class="text-sm text-red-400"></p>
                            <button
                                type="submit"
                                class="w-full py-3 bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75"
                            >
                                Create Group
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.querySelector('.modal-close-button').onclick = () => container.innerHTML = '';

            const memberSelectionList = document.getElementById('memberSelectionList');
            const otherAccounts = accounts.filter(acc => acc.username !== loggedInUser.username);
            memberSelectionList.innerHTML = otherAccounts.map(acc => `
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="member_${acc.id}" value="${acc.username}" class="form-checkbox h-5 w-5 text-yellow-600 rounded-md border-gray-400 focus:ring-yellow-500">
                    <label for="member_${acc.id}" class="ml-2 text-gray-200">${acc.username}</label>
                </div>
            `).join('');

            document.getElementById('createGroupForm').addEventListener('submit', handleCreateGroup);
        }

        async function handleCreateGroup(event) {
            event.preventDefault();
            const groupNameInput = document.getElementById('groupNameInput');
            const groupName = groupNameInput.value.trim();
            const messageElem = document.getElementById('createGroupMessage');

            if (groupName === '') {
                messageElem.textContent = 'Group name cannot be empty.';
                return;
            }

            const selectedMembers = Array.from(document.querySelectorAll('#memberSelectionList input[type="checkbox"]:checked'))
                                        .map(checkbox => checkbox.value);
            selectedMembers.push(loggedInUser.username); // Add creator to the group members

            try {
                const groupsRef = ref(db, `artifacts/${appId}/public/data/groups`);
                const newGroupRef = push(groupsRef); // Generate unique group ID
                const groupId = newGroupRef.key;

                await set(newGroupRef, {
                    name: groupName,
                    creator: loggedInUser.username,
                    members: selectedMembers,
                    createdAt: Date.now()
                });

                messageElem.textContent = `Group '${groupName}' created successfully!`;
                messageElem.classList.remove('text-red-400');
                messageElem.classList.add('text-green-400');
                groupNameInput.value = '';
                // Close modal after a short delay
                setTimeout(() => document.getElementById('confirmModalContainer').innerHTML = '', 1500);
            } catch (error) {
                console.error("Error creating group:", error);
                messageElem.textContent = `Error creating group: ${error.message}`;
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
            }
        }

        function fetchAndDisplayGroups() {
            const groupsListElem = document.getElementById('groupsList');
            const groupsRef = ref(db, `artifacts/${appId}/public/data/groups`);

            // Clean up previous listener if any
            if (window.groupsListenerOff) {
                window.groupsListenerOff();
                window.groupsListenerOff = null;
            }

            window.groupsListenerOff = onValue(groupsRef, (snapshot) => {
                const groupsData = snapshot.val();
                let userGroups = [];
                if (groupsData) {
                    for (const groupId in groupsData) {
                        const group = { id: groupId, ...groupsData[groupId] };
                        if (group.members && group.members.includes(loggedInUser.username)) {
                            userGroups.push(group);
                        }
                    }
                }

                if (userGroups.length === 0) {
                    groupsListElem.innerHTML = '<li class="text-gray-400">No groups found. Create one!</li>';
                } else {
                    groupsListElem.innerHTML = userGroups.map(group => `
                        <li>
                            <button class="group-chat-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md w-full text-left transition duration-200" data-group-id="${group.id}" data-group-name="${group.name}">
                                ${group.name} (${group.members ? group.members.length : 0} members)
                            </button>
                        </li>
                    `).join('');
                }

                // Add event listeners for group chat buttons
                document.querySelectorAll('.group-chat-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const groupId = event.target.dataset.groupId;
                        const groupName = event.target.dataset.groupName;
                        startGroupConversation({ id: groupId, name: groupName });
                    });
                });
            }, (error) => {
                console.error("Error fetching groups:", error);
                groupsListElem.innerHTML = `<li class="text-red-400">Error loading groups: ${error.message}</li>`;
            });
        }

        function startGroupConversation(group) {
            currentGroup = group;
            document.getElementById('groupChatHeader').textContent = `Group: ${group.name}`;
            document.getElementById('groupMessageInput').disabled = false;
            document.getElementById('groupSendBtn').disabled = false;
            document.getElementById('groupMessageInput').focus();

            // Enable toolbar buttons
            document.getElementById('groupToolbar').querySelectorAll('button').forEach(btn => btn.disabled = false);

            // Reset message style for new conversation
            currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null };
            setupStylingToolbar('groupMessageInput', 'groupToolbar'); // Re-init to update button states

            // Clean up previous listener if any
            if (window.groupListenerOff) {
                window.groupListenerOff();
                window.groupListenerOff = null;
            }

            const groupMessagesRef = ref(db, `artifacts/${appId}/public/data/groups/${group.id}/messages`);

            // Set up new listener
            window.groupListenerOff = onValue(groupMessagesRef, (snapshot) => {
                const messagesData = snapshot.val();
                const groupChatWindow = document.getElementById('groupChatWindow');
                groupChatWindow.innerHTML = ''; // Clear previous messages

                if (messagesData) {
                    const messages = Object.keys(messagesData).map(key => ({
                        id: key,
                        ...messagesData[key]
                    })).sort((a, b) => a.timestamp - b.timestamp);

                    messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message-item text-left';

                        let contentHtml = '';
                        if (msg.content.gifUrl) {
                            contentHtml = `<img src="${msg.content.gifUrl}" alt="GIF" class="max-w-full h-auto rounded-md mt-1" onerror="this.onerror=null;this.src='https://placehold.co/200x150/FF0000/FFFFFF?text=GIF+Error';">`;
                            if (msg.content.text) { // Add text as caption if present
                                contentHtml += `<p class="text-gray-200 mt-1" style="font-weight:${msg.content.style?.bold ? 'bold' : 'normal'}; font-style:${msg.content.style?.italic ? 'italic' : 'normal'}; color:${msg.content.style?.color || '#ffffff'};">${msg.content.text}</p>`;
                            }
                        } else if (msg.content.text) {
                            contentHtml = `<p class="text-gray-200 mt-1" style="font-weight:${msg.content.style?.bold ? 'bold' : 'normal'}; font-style:${msg.content.style?.italic ? 'italic' : 'normal'}; color:${msg.content.style?.color || '#ffffff'};">${msg.content.text}</p>`;
                        }

                        messageElement.innerHTML = `
                            <span class="message-sender">${msg.sender}</span>
                            <span class="message-timestamp">${formatTimestamp(msg.timestamp)}</span>
                            ${contentHtml}
                        `;
                        groupChatWindow.prepend(messageElement); // Add to top to keep scroll at bottom
                    });
                    groupChatWindow.scrollTop = groupChatWindow.scrollHeight; // Scroll to bottom
                } else {
                    groupChatWindow.innerHTML = '<p class="text-gray-400 text-center">No messages yet. Start the conversation!</p>';
                }
            }, (error) => {
                console.error("Error fetching group messages:", error);
                document.getElementById('groupChatWindow').innerHTML = `<p class="text-red-400 text-center">Error loading messages: ${error.message}</p>`;
            });
        }

        async function handleSendGroupMessage(event) {
            event.preventDefault();
            if (!loggedInUser || !currentGroup) return;

            const groupMessageInput = document.getElementById('groupMessageInput');
            const messageText = groupMessageInput.value.trim();

            const messageContent = {};

            // If there's text, add it with its style
            if (messageText) {
                messageContent.text = messageText;
                messageContent.style = {
                    bold: currentMessageStyle.bold,
                    italic: currentMessageStyle.italic,
                    color: currentMessageStyle.color
                };
            }

            // Add GIF if a GIF URL is set
            if (currentMessageStyle.gifUrl) {
                messageContent.gifUrl = currentMessageStyle.gifUrl;
            }

            // If neither text nor GIF is present, warn and stop
            if (!messageContent.text && !messageContent.gifUrl) {
                console.warn("Attempted to send empty message: No text and no GIF provided.");
                return;
            }

            const groupMessagesRef = ref(db, `artifacts/${appId}/public/data/groups/${currentGroup.id}/messages`);

            try {
                await push(groupMessagesRef, {
                    sender: loggedInUser.username,
                    content: messageContent,
                    timestamp: Date.now()
                });
                groupMessageInput.value = ''; // Clear input
                currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null };
                setupStylingToolbar('groupMessageInput', 'groupToolbar'); // Re-init to update button states
            } catch (error) {
                console.error("Error sending group message:", error);
                // alert("Failed to send message: " + error.message); // Replaced with console.error
            }
        }

        // --- Forum System ---
        function renderForumPage() {
            if (!loggedInUser) {
                renderAuthRequiredMessage("Please log in to access the Forum.");
                return;
            }

            const contentDiv = document.getElementById('app-content').querySelector('div');
            contentDiv.innerHTML = `
                <div class="space-y-6 text-center w-full max-w-4xl mx-auto">
                    <h2 class="text-4xl font-bold text-indigo-300 mb-4">Forum</h2>
                    <p class="text-lg text-gray-300 leading-relaxed">
                        Discuss various topics with the community.
                    </p>

                    <button id="createTopicBtn" class="px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 mb-6">
                        Create New Topic
                    </button>

                    <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600">
                        <h3 class="text-2xl font-semibold text-indigo-200 mb-4">Latest Topics</h3>
                        <ul id="forumTopicsList" class="text-left space-y-3">
                            <!-- Forum topics will be listed here -->
                        </ul>
                    </div>
                </div>
            `;

            document.getElementById('createTopicBtn').onclick = showCreateTopicModal;
            fetchAndDisplayForumTopics();
        }

        function showCreateTopicModal() {
            const container = document.getElementById('confirmModalContainer'); // Reusing confirm modal container
            container.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-button">&times;</button>
                        <h2 class="text-3xl font-bold text-indigo-300 mb-6 text-center">Create New Forum Topic</h2>
                        <form id="createTopicForm" class="space-y-4">
                            <div>
                                <label for="topicTitleInput" class="block text-gray-300 text-left mb-2">Topic Title:</label>
                                <input
                                    type="text"
                                    id="topicTitleInput"
                                    class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    required
                                />
                            </div>
                            <div>
                                <label for="firstPostContent" class="block text-gray-300 text-left mb-2">First Post Content:</label>
                                <div id="firstPostToolbar" class="editor-toolbar">
                                    <button class="bold-btn"><strong>B</strong></button>
                                    <button class="italic-btn"><em>I</em></button>
                                    <button class="color-btn">Color</button>
                                    <button class="emoji-btn">ğŸ˜€</button>
                                    <button class="gif-btn">GIF</button>
                                </div>
                                <textarea
                                    id="firstPostContent"
                                    class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 h-32"
                                    rows="5"
                                    required
                                ></textarea>
                            </div>
                            <p id="createTopicMessage" class="text-sm text-red-400"></p>
                            <button
                                type="submit"
                                class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75"
                            >
                                Create Topic
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.querySelector('.modal-close-button').onclick = () => container.innerHTML = '';
            document.getElementById('createTopicForm').addEventListener('submit', handleCreateTopic);

            // Setup styling toolbar for first post input
            currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null }; // Reset for new topic
            setupStylingToolbar('firstPostContent', 'firstPostToolbar');
        }

        async function handleCreateTopic(event) {
            event.preventDefault();
            const topicTitleInput = document.getElementById('topicTitleInput');
            const firstPostContentInput = document.getElementById('firstPostContent');
            const messageElem = document.getElementById('createTopicMessage');

            const title = topicTitleInput.value.trim();
            const contentText = firstPostContentInput.value.trim();

            const postContent = {};
            // If there's text, add it with its style
            if (contentText) {
                postContent.text = contentText;
                postContent.style = {
                    bold: currentMessageStyle.bold,
                    italic: currentMessageStyle.italic,
                    color: currentMessageStyle.color
                };
            }

            // Add GIF if a GIF URL is set
            if (currentMessageStyle.gifUrl) {
                postContent.gifUrl = currentMessageStyle.gifUrl;
            }

            // If neither text nor GIF is present, warn and stop
            if (!postContent.text && !postContent.gifUrl) {
                messageElem.textContent = 'Please enter a message or select a GIF.';
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
                return;
            }

            if (title === '') {
                messageElem.textContent = 'Topic title cannot be empty.';
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
                return;
            }

            try {
                const forumTopicsRef = ref(db, `artifacts/${appId}/public/data/forum/topics`);
                const newTopicRef = push(forumTopicsRef); // Generate unique topic ID
                const topicId = newTopicRef.key;

                // Set topic metadata
                await set(newTopicRef, {
                    title: title,
                    creator: loggedInUser.username,
                    createdAt: Date.now()
                });

                // Add the first post
                const topicPostsRef = ref(db, `artifacts/${appId}/public/data/forum/topics/${topicId}/posts`);
                await push(topicPostsRef, {
                    author: loggedInUser.username,
                    content: postContent,
                    timestamp: Date.now()
                });

                messageElem.textContent = `Topic '${title}' created successfully!`;
                messageElem.classList.remove('text-red-400');
                messageElem.classList.add('text-green-400');
                topicTitleInput.value = '';
                firstPostContentInput.value = '';
                currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null }; // Reset styling
                setupStylingToolbar('firstPostContent', 'firstPostToolbar'); // Re-init to update button states
                // Close modal after a short delay
                setTimeout(() => document.getElementById('confirmModalContainer').innerHTML = '', 1500);
            } catch (error) {
                console.error("Error creating topic:", error);
                messageElem.textContent = `Error creating topic: ${error.message}`;
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
            }
        }

        function fetchAndDisplayForumTopics() {
            const forumTopicsListElem = document.getElementById('forumTopicsList');
            const forumTopicsRef = ref(db, `artifacts/${appId}/public/data/forum/topics`);

            // Clean up previous listener if any
            if (window.forumTopicsListenerOff) {
                window.forumTopicsListenerOff();
                window.forumTopicsListenerOff = null;
            }

            window.forumTopicsListenerOff = onValue(forumTopicsRef, (snapshot) => {
                const topicsData = snapshot.val();
                let topics = [];
                if (topicsData) {
                    for (const topicId in topicsData) {
                        topics.push({ id: topicId, ...topicsData[topicId] });
                    }
                }

                if (topics.length === 0) {
                    forumTopicsListElem.innerHTML = '<li class="text-gray-400">No topics found. Be the first to create one!</li>';
                } else {
                    // Sort topics by creation date, newest first
                    topics.sort((a, b) => b.createdAt - a.createdAt);
                    forumTopicsListElem.innerHTML = topics.map(topic => `
                        <li>
                            <button class="forum-topic-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md w-full text-left transition duration-200" data-topic-id="${topic.id}" data-topic-title="${topic.title}">
                                <span class="font-semibold text-lg text-indigo-100">${topic.title}</span>
                                <span class="text-sm text-gray-400 ml-2">by ${topic.creator} on ${formatTimestamp(topic.createdAt)}</span>
                            </button>
                        </li>
                    `).join('');
                }

                // Add event listeners for forum topic buttons
                document.querySelectorAll('.forum-topic-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const topicId = event.target.dataset.topicId;
                        const topicTitle = event.target.dataset.topicTitle;
                        viewForumTopic({ id: topicId, title: topicTitle });
                    });
                });
            }, (error) => {
                console.error("Error fetching forum topics:", error);
                forumTopicsListElem.innerHTML = `<li class="text-red-400">Error loading topics: ${error.message}</li>`;
            });
        }

        function viewForumTopic(topic) {
            currentForumTopic = topic;
            const contentDiv = document.getElementById('app-content').querySelector('div');
            contentDiv.innerHTML = `
                <div class="space-y-6 text-center w-full max-w-4xl mx-auto">
                    <h2 class="text-4xl font-bold text-indigo-300 mb-4">${topic.title}</h2>
                    <button id="backToForumBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 mb-6">
                        &larr; Back to Forum
                    </button>

                    <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600">
                        <h3 class="text-2xl font-semibold text-indigo-200 mb-4">Posts</h3>
                        <div id="forumPostsList" class="post-list h-96 mb-4 flex flex-col-reverse">
                            <!-- Posts will appear here -->
                        </div>
                        <div id="forumPostToolbar" class="editor-toolbar">
                            <button class="bold-btn"><strong>B</strong></button>
                            <button class="italic-btn"><em>I</em></button>
                            <button class="color-btn">Color</button>
                            <button class="emoji-btn">ğŸ˜€</button>
                            <button class="gif-btn">GIF</button>
                        </div>
                        <form id="forumPostForm" class="flex flex-col gap-3">
                            <textarea
                                id="forumPostInput"
                                class="w-full p-3 rounded-md bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 h-24"
                                placeholder="Write your reply..."
                                rows="5"
                                required
                            ></textarea>
                            <button
                                type="submit"
                                id="forumSendPostBtn"
                                class="px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75"
                            >
                                Post Reply
                            </button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('backToForumBtn').onclick = () => {
                currentPage = 'forum';
                updatePageContent();
            };
            document.getElementById('forumPostForm').addEventListener('submit', handleSendForumPost);

            // Setup styling toolbar for forum post input
            currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null }; // Reset for new post
            setupStylingToolbar('forumPostInput', 'forumPostToolbar');

            // Fetch and display posts for this topic
            fetchAndDisplayForumPosts(topic.id);
        }

        function fetchAndDisplayForumPosts(topicId) {
            const forumPostsListElem = document.getElementById('forumPostsList');
            const topicPostsRef = ref(db, `artifacts/${appId}/public/data/forum/topics/${topicId}/posts`);

            // Clean up previous listener if any
            if (window.forumPostsListenerOff) {
                window.forumPostsListenerOff();
                window.forumPostsListenerOff = null;
            }

            window.forumPostsListenerOff = onValue(topicPostsRef, (snapshot) => {
                const postsData = snapshot.val();
                forumPostsListElem.innerHTML = ''; // Clear previous posts

                if (postsData) {
                    const posts = Object.keys(postsData).map(key => ({
                        id: key,
                        ...postsData[key]
                    })).sort((a, b) => a.timestamp - b.timestamp);

                    posts.forEach(post => {
                        const postElement = document.createElement('div');
                        postElement.className = 'post-item text-left';

                        let contentHtml = '';
                        if (post.content.gifUrl) {
                            contentHtml = `<img src="${post.content.gifUrl}" alt="GIF" class="max-w-full h-auto rounded-md mt-1" onerror="this.onerror=null;this.src='https://placehold.co/200x150/FF0000/FFFFFF?text=GIF+Error';">`;
                            if (post.content.text) { // Add text as caption if present
                                contentHtml += `<p class="text-gray-200 mt-1" style="font-weight:${post.content.style?.bold ? 'bold' : 'normal'}; font-style:${post.content.style?.italic ? 'italic' : 'normal'}; color:${post.content.style?.color || '#ffffff'};">${post.content.text}</p>`;
                            }
                        } else if (post.content.text) {
                            contentHtml = `<p class="text-gray-200 mt-1" style="font-weight:${post.content.style?.bold ? 'bold' : 'normal'}; font-style:${post.content.style?.italic ? 'italic' : 'normal'}; color:${post.content.style?.color || '#ffffff'};">${post.content.text}</p>`;
                        }

                        postElement.innerHTML = `
                            <span class="post-author">${post.author}</span>
                            <span class="post-timestamp">${formatTimestamp(post.timestamp)}</span>
                            ${contentHtml}
                        `;
                        forumPostsListElem.prepend(postElement); // Add to top to keep scroll at bottom
                    });
                    forumPostsListElem.scrollTop = forumPostsListElem.scrollHeight; // Scroll to bottom
                } else {
                    forumPostsListElem.innerHTML = '<p class="text-gray-400 text-center">No posts yet. Be the first to reply!</p>';
                }
            }, (error) => {
                console.error("Error fetching forum posts:", error);
                forumPostsListElem.innerHTML = `<p class="text-red-400 text-center">Error loading posts: ${error.message}</p>`;
            });
        }

        async function handleSendForumPost(event) {
            event.preventDefault();
            if (!loggedInUser || !currentForumTopic) return;

            const forumPostInput = document.getElementById('forumPostInput');
            const postText = forumPostInput.value.trim();

            const postContent = {};
            // If there's text, add it with its style
            if (postText) {
                postContent.text = postText;
                postContent.style = {
                    bold: currentMessageStyle.bold,
                    italic: currentMessageStyle.italic,
                    color: currentMessageStyle.color
                };
            }

            // Add GIF if a GIF URL is set
            if (currentMessageStyle.gifUrl) {
                postContent.gifUrl = currentMessageStyle.gifUrl;
            }

            // If neither text nor GIF is present, warn and stop
            if (!postContent.text && !postContent.gifUrl) {
                console.warn("Attempted to send empty post: No text and no GIF provided.");
                return;
            }

            const topicPostsRef = ref(db, `artifacts/${appId}/public/data/forum/topics/${currentForumTopic.id}/posts`);

            try {
                await push(topicPostsRef, {
                    author: loggedInUser.username,
                    content: postContent,
                    timestamp: Date.now()
                });
                forumPostInput.value = ''; // Clear input
                currentMessageStyle = { bold: false, italic: false, color: '#ffffff', gifUrl: null }; // Reset styling
                setupStylingToolbar('forumPostInput', 'forumPostToolbar'); // Re-init to update button states
            } catch (error) {
                console.error("Error sending forum post:", error);
                // alert("Failed to send post: " + error.message); // Replaced with console.error
            }
        }


        function renderAuthRequiredMessage(message) {
            const contentDiv = document.getElementById('app-content').querySelector('div');
            contentDiv.innerHTML = `
                <div class="space-y-6 text-center">
                    <h2 class="text-4xl font-bold text-red-400 mb-4">Access Denied</h2>
                    <p class="text-lg text-gray-300 leading-relaxed">${message}</p>
                    <button id="loginNowBtn" class="mt-8 px-8 py-4 bg-gradient-to-r from-red-600 to-red-800 text-white font-bold text-xl rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                        Login Now
                    </button>
                </div>
            `;
            document.getElementById('loginNowBtn').onclick = () => showLoginModal();
        }

        // --- Main Page Rendering Logic ---
        function updatePageContent() {
            switch (currentPage) {
                case 'home':
                    renderHomePage();
                    break;
                case 'memberMenu':
                    if (loggedInUser && (loggedInUser.role === 'member' || loggedInUser.role === 'admin' || loggedInUser.role === 'master')) {
                        renderMemberMenuPage();
                    } else {
                        renderAuthRequiredMessage("Please log in to access the Member Menu.");
                    }
                    break;
                case 'services':
                    renderServicesPage();
                    break;
                case 'directMessages':
                    renderDirectMessagesPage();
                    break;
                case 'messageGroups':
                    renderMessageGroupsPage();
                    break;
                case 'forum':
                    renderForumPage();
                    break;
                case 'adminMenu':
                    if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'master')) {
                        renderAdminMenuPage();
                    } else {
                        renderAuthRequiredMessage("Admin access required. Please log in.");
                    }
                    break;
                case 'masterMenu':
                    if (loggedInUser && loggedInUser.role === 'master') {
                        renderMasterMenuPage();
                    } else {
                        renderAuthRequiredMessage("Master access required. Please log in.");
                    }
                    break;
                default:
                    renderHomePage();
            }
            updateNavigationButtons();
        }

        // --- Navigation and Auth Button Logic ---
        function updateNavigationButtons() {
            const adminBtn = document.getElementById('adminMenuBtn');
            const masterBtn = document.getElementById('masterMenuBtn');
            const authBtn = document.getElementById('authBtn');
            const dmBtn = document.getElementById('dmBtn');
            const groupChatBtn = document.getElementById('groupChatBtn');
            const forumBtn = document.getElementById('forumBtn');

            if (loggedInUser) {
                authBtn.textContent = `Logout (${loggedInUser.username})`;
                authBtn.onclick = handleLogout;
                dmBtn.classList.remove('hidden');
                groupChatBtn.classList.remove('hidden');
                forumBtn.classList.remove('hidden');
            } else {
                authBtn.textContent = 'Login';
                authBtn.onclick = showLoginModal;
                dmBtn.classList.add('hidden');
                groupChatBtn.classList.add('hidden');
                forumBtn.classList.add('hidden');
            }

            if (loggedInUser && loggedInUser.role === 'admin') {
                adminBtn.classList.remove('hidden');
                masterBtn.classList.add('hidden');
            } else if (loggedInUser && loggedInUser.role === 'master') {
                adminBtn.classList.remove('hidden');
                masterBtn.classList.remove('hidden');
            } else {
                adminBtn.classList.add('hidden');
                masterBtn.classList.add('hidden');
            }
        }

        // --- Login Modal Logic ---
        function showLoginModal() {
            const container = document.getElementById('loginModalContainer');
            container.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-button">&times;</button>
                        <h2 class="text-3xl font-bold text-teal-300 mb-6 text-center">Login</h2>
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label for="loginUsername" class="block text-gray-300 text-left mb-2">Username:</label>
                                <input
                                    type="text"
                                    id="loginUsername"
                                    class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    required
                                />
                            </div>
                            <div>
                                <label for="loginPassword" class="block text-gray-300 text-left mb-2">Password:</label>
                                <input
                                    type="password"
                                    id="loginPassword"
                                    class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    required
                                />
                            </div>
                            <div class="text-center text-gray-400">OR</div>
                            <div>
                                <label for="loginAccessCode" class="block text-gray-300 text-left mb-2">Admin/Master Access Code:</label>
                                <input
                                    type="password"
                                    id="loginAccessCode"
                                    class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    placeholder="Enter admin or master code"
                                />
                            </div>
                            <p id="loginError" class="text-red-400 text-sm text-center"></p>
                            <button
                                type="submit"
                                class="w-full py-3 bg-gradient-to-r from-teal-500 to-blue-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75"
                            >
                                Login
                            </button>
                        </form>
                    </div>
                </div>
            `;

            document.querySelector('.modal-close-button').onclick = () => container.innerHTML = '';
            document.getElementById('loginForm').addEventListener('submit', handleLoginAttempt);
        }

        function handleLoginAttempt(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const accessCode = document.getElementById('loginAccessCode').value;
            const loginErrorElem = document.getElementById('loginError');
            loginErrorElem.textContent = ''; // Clear previous errors

            console.log(`Login attempt for username: ${username}, password: ${password}, accessCode: ${accessCode}`);

            let userFound = null;

            // Check for master access code
            if (accessCode === MASTER_CODE) {
                userFound = { username: 'Master User', role: 'master' };
                console.log("Master access code matched.");
            }
            // Check for admin access code
            else if (accessCode === ADMIN_CODE) {
                userFound = { username: 'Admin User', role: 'admin' };
                console.log("Admin access code matched.");
            }
            // Check for regular user login against Realtime Database accounts
            else {
                userFound = accounts.find(acc => acc.username === username && acc.password === password);
                console.log("Searching in fetched accounts:", accounts);
                console.log("User found by find operation:", userFound);
            }

            if (userFound) {
                loggedInUser = userFound;
                document.getElementById('loginModalContainer').innerHTML = ''; // Close modal
                updatePageContent(); // Re-render page with logged-in state
                console.log(`Login successful for user: ${loggedInUser.username} with role: ${loggedInUser.role}`);
            } else {
                loginErrorElem.textContent = 'Invalid username or password, or incorrect access code.';
                console.log("Login failed: No user found or credentials incorrect.");
            }
        }

        function handleLogout() {
            if (auth) {
                auth.signOut().then(() => {
                    loggedInUser = null;
                    currentUserId = null;
                    currentPage = 'home';
                    updatePageContent();
                    document.getElementById('userIdDisplay').classList.add('hidden');
                    console.log("User logged out.");
                }).catch((error) => {
                    console.error("Error signing out:", error);
                });
            }
        }

        // --- Realtime Database Account Management Logic (Admin/Master Menus) ---
        async function handleCreateAccount(event) {
            event.preventDefault();
            const form = event.target;
            const usernameInput = form.querySelector('#newUsername');
            const passwordInput = form.querySelector('#newPassword');
            const roleSelect = form.querySelector('#newRole');
            const messageElem = form.querySelector('#adminMessage');
            const createBtn = form.querySelector('#createAccountBtn');

            const newUsername = usernameInput.value;
            const newPassword = passwordInput.value;
            const newRole = roleSelect.value;

            messageElem.textContent = '';
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';

            if (accounts.some(acc => acc.username === newUsername)) {
                messageElem.textContent = 'Error: Username already exists.';
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
                createBtn.disabled = false;
                createBtn.textContent = 'Create Account';
                console.error(`Account creation failed: Username '${newUsername}' already exists.`);
                return;
            }

            if (newRole === 'admin' && loggedInUser.role !== 'master') {
                messageElem.textContent = 'Error: Only Master users can create Admin accounts.';
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
                createBtn.disabled = false;
                createBtn.textContent = 'Create Account';
                console.error("Account creation failed: Insufficient role for creating admin account.");
                return;
            }

            try {
                // Realtime Database uses push() for unique keys
                const newAccountRef = push(ref(db, `artifacts/${appId}/public/data/accounts`));
                await set(newAccountRef, { username: newUsername, password: newPassword, role: newRole });
                messageElem.textContent = `Account '${newUsername}' with role '${newRole}' created successfully!`;
                messageElem.classList.remove('text-red-400');
                messageElem.classList.add('text-green-400');
                usernameInput.value = '';
                passwordInput.value = '';
                roleSelect.value = 'member';
                console.log(`Account '${newUsername}' created successfully.`);
            } catch (error) {
                console.error("Error creating account:", error);
                messageElem.textContent = `Error creating account: ${error.message}`;
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Create Account';
            }
        }

        async function handleCreateMasterAccount(event) {
            event.preventDefault();
            const form = event.target;
            const usernameInput = form.querySelector('#newMasterUsername');
            const passwordInput = form.querySelector('#newMasterPassword');
            const roleSelect = form.querySelector('#newMasterRole');
            const messageElem = form.querySelector('#masterMessage');
            const createBtn = form.querySelector('#createMasterAccountBtn');

            const newUsername = usernameInput.value;
            const newPassword = passwordInput.value;
            const newRole = roleSelect.value;

            messageElem.textContent = '';
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';

            if (accounts.some(acc => acc.username === newUsername)) {
                messageElem.textContent = 'Error: Username already exists.';
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
                createBtn.disabled = false;
                createBtn.textContent = 'Create Account';
                console.error(`Account creation failed (Master): Username '${newUsername}' already exists.`);
                return;
            }

            try {
                const newAccountRef = push(ref(db, `artifacts/${appId}/public/data/accounts`));
                await set(newAccountRef, { username: newUsername, password: newPassword, role: newRole });
                messageElem.textContent = `Account '${newUsername}' with role '${newRole}' created successfully!`;
                messageElem.classList.remove('text-red-400');
                messageElem.classList.add('text-green-400');
                usernameInput.value = '';
                passwordInput.value = '';
                roleSelect.value = 'member';
                console.log(`Account '${newUsername}' created successfully from Master menu.`);
            } catch (error) {
                console.error("Error creating account from master menu:", error);
                messageElem.textContent = `Error creating account: ${error.message}`;
                messageElem.classList.remove('text-green-400');
                messageElem.classList.add('text-red-400');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Create Account';
            }
        }

        async function handleDeleteAccount(accountId, username) {
            showConfirmModal(`Are you sure you want to delete account '${username}'?`, async (confirmed) => {
                if (confirmed) {
                    try {
                        // Realtime Database uses remove()
                        await remove(ref(db, `artifacts/${appId}/public/data/accounts/${accountId}`));
                        console.log(`Account '${username}' deleted successfully!`);
                        // No need to manually update accounts array, onValue will handle it
                        updatePageContent(); // Re-render the current page to update the list
                    } catch (error) {
                        console.error("Error deleting account:", error);
                        // alert(`Error deleting account: ${error.message}`); // Replaced with console.error
                    }
                }
            });
        }

        // --- Initialization and Event Listeners ---
        window.onload = function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Initialize Firebase
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyDaq6yV-zyf_E5BBK1uNd6i3QtOJ1cQaG8",
                    authDomain: "hunt3rs-db-f10d3.firebaseapp.com",
                    projectId: "hunt3rs-db-f10d3",
                    storageBucket: "hunt3rs-db-f10d3.firebasestorage.app",
                    messagingSenderId: "741953319280",
                    appId: "1:741953319280:web:8ab9db64a81ac151f79fb5",
                    databaseURL: "https://hunt3rs-db-f10d3-default-rtdb.firebaseio.com" // Your Realtime Database URL
                };

                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app); // Initialize Realtime Database

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `Your User ID: ${currentUserId}`;
                        document.getElementById('userIdDisplay').classList.remove('hidden');
                        console.log("Firebase Auth State Changed: User logged in with UID:", currentUserId);
                    } else {
                        console.log("Firebase Auth State Changed: No user, attempting anonymous or custom token login.");
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    updatePageContent(); // Initial render after auth is ready
                });

                // Set up real-time listener for accounts in Realtime Database
                const accountsRef = ref(db, `artifacts/${appId}/public/data/accounts`);
                onValue(accountsRef, (snapshot) => {
                    const data = snapshot.val();
                    accounts = [];
                    if (data) {
                        for (const key in data) {
                            accounts.push({ id: key, ...data[key] });
                        }
                    }
                    console.log("Accounts fetched from Realtime Database (onValue update):", accounts);

                    // Add holTEST1 if it doesn't exist in Realtime Database
                    const holTest1Exists = accounts.some(acc => acc.username === 'holTEST1');
                    if (!holTest1Exists) {
                        console.log("holTEST1 not found in Realtime Database, adding it now...");
                        const newAccountRef = push(accountsRef); // Generate a unique key
                        set(newAccountRef, { username: 'holTEST1', password: 'holTEST1!tester@test#1', role: 'member' })
                            .then(() => console.log("holTEST1 account added to Realtime Database successfully."))
                            .catch(e => console.error("Error adding holTEST1 to Realtime Database:", e));
                    }
                    updatePageContent(); // Re-render the current page to reflect updated accounts list
                }, (error) => {
                    console.error("Error fetching accounts from Realtime Database (onValue error):", error);
                    document.getElementById('app-content').querySelector('div').innerHTML = `<div class="text-center text-xl text-red-400">Error loading accounts: ${error.message}</div>`;
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('app-content').querySelector('div').innerHTML = `<div class="text-center text-xl text-red-400">Error initializing website: ${error.message}</div>`;
            }

            // Navigation button event listeners
            document.getElementById('homeBtn').onclick = () => { currentPage = 'home'; updatePageContent(); };
            document.getElementById('memberMenuBtn').onclick = () => { currentPage = 'memberMenu'; updatePageContent(); };
            document.getElementById('servicesBtn').onclick = () => { currentPage = 'services'; updatePageContent(); };
            document.getElementById('dmBtn').onclick = () => { currentPage = 'directMessages'; updatePageContent(); };
            document.getElementById('groupChatBtn').onclick = () => { currentPage = 'messageGroups'; updatePageContent(); };
            document.getElementById('forumBtn').onclick = () => { currentPage = 'forum'; updatePageContent(); };
            document.getElementById('adminMenuBtn').onclick = () => { currentPage = 'adminMenu'; updatePageContent(); };
            document.getElementById('masterMenuBtn').onclick = () => { currentPage = 'masterMenu'; updatePageContent(); };
        };
    </script>
</body>
</html>
ï¿½
